@page "/"
@inject IChallengeRepository ChallengeRepository
@inject IRankRepository RankRepository
@inject IKillerRepository KillerRepository
@inject ILogger<Home> Logger

<div class="home-page">
    @if (_isLoading)
    {
        <div class="loading-ritual">
            <div class="loading-circle">
                <div class="inner-circle"></div>
                <div class="loading-text">Summoning the Entity...</div>
            </div>
        </div>
    }
    else if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="error-shrine">
            <div class="error-flames"></div>
            <div class="error-content">
                <div class="error-skull">💀</div>
                <h3>The Entity Rejects You</h3>
                <p>@_errorMessage</p>
                <button class="btn btn-blood" @onclick="LoadInitialData">
                    <span class="btn-icon">🔥</span>
                    Retry Ritual
                </button>
            </div>
        </div>
    }
    else
    {
        <!-- Main Challenge Creation Arena -->
        <div class="challenge-arena">
            <!-- Introduction Ritual -->
            <div class="ritual-intro">
                <div class="intro-content">
                    <h1 class="ritual-title">CREATE NEW CHALLENGE</h1>
                    <p class="ritual-description">
                        Configure your hardcore challenge parameters. Set financial constraints and starting position to test your mastery of the Entity's realm.
                    </p>
                    <div class="ritual-warning">
                        <div class="warning-item">
                            <span class="warning-icon">⚠️</span>
                            <span>Choose wisely. Parameters cannot be changed once the challenge begins.</span>
                        </div>
                        <div class="warning-item">
                            <span class="warning-icon">💰</span>
                            <span>Killer prices are locked during challenges. Adjust costs in Killer Management first.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Challenge Configuration Altar -->
            <div class="configuration-altar">
                <div class="altar-base">
                    <div class="altar-glow"></div>
                    <div class="altar-content">
                        <!-- Altar Header -->
                        <div class="altar-header">
                            <div class="header-ornament left"></div>
                            <div class="header-title">
                                <div class="title-runes">⟨ ⟨ ⟨</div>
                                <h3>CHALLENGE CONFIGURATION</h3>
                                <div class="title-runes">⟩ ⟩ ⟩</div>
                            </div>
                            <div class="header-ornament right"></div>
                        </div>

                        <!-- Configuration Grid -->
                        <div class="config-grid">
                            <!-- Financial Constraints -->
                            <div class="config-section funds-section">
                                <div class="section-header">
                                    <div class="section-icon">💰</div>
                                    <h4>FINANCIAL CONSTRAINTS</h4>
                                </div>
                                
                                <div class="input-ritual">
                                    <label class="ritual-label">
                                        <span class="label-rune">₹</span>
                                        STARTING FUNDS
                                    </label>
                                    <div class="cursed-input-group">
                                        <div class="currency-seal">$</div>
                                        <input @bind="_challengeBankFunds"
                                               @bind:event="oninput"
                                               type="number"
                                               min="0"
                                               step="50"
                                               class="cursed-input"
                                               placeholder="500" />
                                        <div class="input-glow"></div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(_bankFundsError))
                                    {
                                        <div class="curse-warning">@_bankFundsError</div>
                                    }
                                    <div class="input-whisper">Your initial budget for killer purchases</div>
                                </div>

                                <div class="input-ritual">
                                    <label class="ritual-label">
                                        <span class="label-rune">🏦</span>
                                        MAXIMUM FUNDS
                                    </label>
                                    <div class="cursed-input-group">
                                        <div class="currency-seal">$</div>
                                        <input @bind="_challengeMaxFunds"
                                               @bind:event="oninput"
                                               type="number"
                                               min="0"
                                               step="100"
                                               class="cursed-input"
                                               placeholder="2000" />
                                        <div class="input-glow"></div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(_maxFundsError))
                                    {
                                        <div class="curse-warning">@_maxFundsError</div>
                                    }
                                    <div class="input-whisper">Maximum funds you can accumulate</div>
                                </div>
                            </div>

                            <!-- Rank Selection Shrine -->
                            <div class="config-section rank-section">
                                <div class="section-header">
                                    <div class="section-icon">👑</div>
                                    <h4>STARTING POSITION</h4>
                                </div>

                                <div class="input-ritual">
                                    <label class="ritual-label">
                                        <span class="label-rune">📊</span>
                                        INITIAL RANK
                                    </label>
                                    <div class="rank-selector" @onclick="ToggleRankDropdown">
                                        <div class="selected-dominion">
                                            @if (!string.IsNullOrEmpty(_challengeRankId))
                                            {
                                                var selectedRank = _ranks.FirstOrDefault(r => r.Id == _challengeRankId);
                                                if (selectedRank != null)
                                                {
                                                    <span class="dominion-icon">@GetRankIcon(selectedRank)</span>
                                                    <span class="dominion-name">@selectedRank.GetDisplayName()</span>
                                                    <span class="dominion-power">@selectedRank.PipRequirement pips</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="dominion-placeholder">Choose your starting rank...</span>
                                            }
                                        </div>
                                        <div class="selector-arrow @(_showRankDropdown ? "summoned" : "")">⚡</div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(_rankError))
                                    {
                                        <div class="curse-warning">@_rankError</div>
                                    }
                                    <div class="input-whisper">Your current DBD rank position</div>
                                </div>
                            </div>
                        </div>

                        <!-- Challenge Preview -->
                        <div class="prophecy-crystal">
                            <div class="crystal-glow"></div>
                            <div class="prophecy-content">
                                <div class="prophecy-header">
                                    <div class="crystal-icon">🔮</div>
                                    <span>CHALLENGE PREVIEW</span>
                                </div>
                                <div class="prophecy-grid">
                                    <div class="prophecy-rune">
                                        <span class="rune-label">Starting Budget:</span>
                                        <span class="rune-value bloodmoney">$@_challengeBankFunds.ToString("N0")</span>
                                    </div>
                                    <div class="prophecy-rune">
                                        <span class="rune-label">Fund Limit:</span>
                                        <span class="rune-value vault">$@_challengeMaxFunds.ToString("N0")</span>
                                    </div>
                                    <div class="prophecy-rune">
                                        <span class="rune-label">Starting Rank:</span>
                                        <span class="rune-value rank">@GetRankDisplayName(_challengeRankId)</span>
                                    </div>
                                    <div class="prophecy-rune">
                                        <span class="rune-label">Difficulty Level:</span>
                                        <span class="rune-value difficulty @GetDifficultyLevel().ToLower()">@GetDifficultyLevel()</span>
                                    </div>
                                </div>
                                @if (_averageKillerCost > 0)
                                {
                                    <div class="entity-whispers">
                                        <div class="whisper-orbs">
                                            <div class="orb orb-1">
                                                <span class="orb-label">Avg. Killer Cost</span>
                                                <span class="orb-value">$@_averageKillerCost.ToString("F0")</span>
                                            </div>
                                            <div class="orb orb-2">
                                                <span class="orb-label">Initial Purchases</span>
                                                <span class="orb-value">~@(Math.Floor(_challengeBankFunds / _averageKillerCost))</span>
                                            </div>
                                            <div class="orb orb-3">
                                                <span class="orb-label">Max Purchases</span>
                                                <span class="orb-value">~@(Math.Floor(_challengeMaxFunds / _averageKillerCost))</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="ritual-actions">
                            <div class="action-flames">
                                <div class="action-flame left"></div>
                                <div class="action-flame right"></div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-void" @onclick="ResetForm">
                                    <span class="btn-rune">🌀</span>
                                    <span>RESET FORM</span>
                                </button>
                                <button class="btn btn-blood btn-massive"
                                        @onclick="CreateChallenge"
                                        disabled="@(_isCreating || !_isFormValid)">
                                    <div class="btn-energy"></div>
                                    @if (_isCreating)
                                    {
                                        <span class="btn-rune pulsing">⚡</span>
                                        <span>CREATING...</span>
                                    }
                                    else
                                    {
                                        <span class="btn-rune">🔥</span>
                                        <span>START CHALLENGE</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Information Cards -->
            <div class="knowledge-tablets">
                <div class="tablet-header">
                    <h3>CHALLENGE MECHANICS</h3>
                </div>
                <div class="tablets-grid">
                    <div class="knowledge-tablet">
                        <div class="tablet-seal">💎</div>
                        <div class="tablet-content">
                            <h4>Economic Pressure</h4>
                            <p>Your budget constraints force strategic killer selection. Lower budgets create high-stakes decisions where every purchase matters.</p>
                        </div>
                        <div class="tablet-glow"></div>
                    </div>
                    <div class="knowledge-tablet">
                        <div class="tablet-seal">⚱️</div>
                        <div class="tablet-content">
                            <h4>Fund Management</h4>
                        <p>Balance spending on expensive killers vs building reserves. The fund cap prevents infinite hoarding and maintains pressure.</p>
                        </div>
                        <div class="tablet-glow"></div>
                    </div>
                    <div class="knowledge-tablet">
                        <div class="tablet-seal">⚖️</div>
                        <div class="tablet-content">
                            <h4>Rank Progression</h4>
                            <p>Start from your current DBD rank and climb through wins. Economic constraints add strategy to your rank advancement journey.</p>
                        </div>
                        <div class="tablet-glow"></div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Rank Selection Modal -->
    @if (_showRankDropdown)
    {
        <div class="portal-overlay" @onclick="CloseRankDropdown">
            <div class="rank-portal" @onclick:stopPropagation="true">
                <div class="portal-energy"></div>
                <div class="portal-header">
                    <div class="portal-title">
                        <span class="portal-rune">👑</span>
                        <span>SELECT STARTING RANK</span>
                    </div>
                    <button class="portal-seal" @onclick="CloseRankDropdown">✕</button>
                </div>
                <div class="dominion-list">
                    @foreach (var rank in _ranks.OrderBy(r => r.OrderIndex))
                    {
                        <div class="dominion-entry @(rank.Id == _challengeRankId ? "chosen" : "")" 
                             @onclick="() => SelectRank(rank.Id)">
                            <div class="entry-aura"></div>
                            <span class="dominion-seal">@GetRankIcon(rank)</span>
                            <div class="dominion-info">
                                <span class="dominion-title">@rank.GetDisplayName()</span>
                                <span class="dominion-requirement">@rank.PipRequirement pip@(rank.PipRequirement != 1 ? "s" : "") required</span>
                            </div>
                            @if (rank.Id == _challengeRankId)
                            {
                                <span class="chosen-mark">✦</span>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    // Data
    private List<Rank> _ranks = new();
    private List<Killer> _killers = new();
    private bool _isLoading = true;
    private string? _errorMessage = null;
    private decimal _averageKillerCost = 0;

    // Form state
    private bool _isCreating = false;
    private int _challengeBankFunds = 500;
    private int _challengeMaxFunds = 2000;
    private string _challengeRankId = "";

    // UI state
    private bool _showRankDropdown = false;

    // Form validation
    private string? _bankFundsError = null;
    private string? _maxFundsError = null;
    private string? _rankError = null;
    private bool _isFormValid = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
        ValidateForm();
    }

    private async Task LoadInitialData()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            StateHasChanged();

            Logger.LogInformation("Loading initial data for challenge creation");

            // Load ranks
            var rankResult = await RankRepository.GetAllOrderedAsync();
            if (rankResult.IsSuccess)
            {
                _ranks = rankResult.Value?.ToList() ?? new List<Rank>();
                
                var lowestRank = _ranks.FirstOrDefault();
                if (lowestRank != null)
                {
                    _challengeRankId = lowestRank.Id;
                }

                Logger.LogInformation("Loaded {Count} ranks", _ranks.Count);
            }
            else
            {
                _errorMessage = $"Failed to load ranks: {rankResult.Error}";
                Logger.LogError("Failed to load ranks: {Error}", rankResult.Error);
                return;
            }

            // Load killers for cost calculation
            var killerResult = await KillerRepository.GetAllAsync();
            if (killerResult.IsSuccess)
            {
                _killers = killerResult.Value?.ToList() ?? new List<Killer>();
                
                if (_killers.Any())
                {
                    _averageKillerCost = (decimal)_killers.Average(k => k.BaseCost);
                }

                Logger.LogInformation("Loaded {Count} killers, average cost: {AvgCost:F1}", 
                    _killers.Count, _averageKillerCost);
            }
            else
            {
                Logger.LogWarning("Failed to load killers: {Error}", killerResult.Error);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unexpected error: {ex.Message}";
            Logger.LogError(ex, "Error loading initial data");
        }
        finally
        {
            _isLoading = false;
            ValidateForm();
            StateHasChanged();
        }
    }

    private void ValidateForm()
    {
        _bankFundsError = null;
        _maxFundsError = null;
        _rankError = null;

        var isValid = true;

        if (_challengeBankFunds < 0)
        {
            _bankFundsError = "Starting funds cannot be negative";
            isValid = false;
        }
        else if (_challengeBankFunds < 50)
        {
            _bankFundsError = "Minimum starting funds: $50";
            isValid = false;
        }

        if (_challengeMaxFunds < 0)
        {
            _maxFundsError = "Maximum funds cannot be negative";
            isValid = false;
        }
        else if (_challengeMaxFunds < _challengeBankFunds)
        {
            _maxFundsError = "Maximum funds must be at least equal to starting funds";
            isValid = false;
        }
        else if (_challengeMaxFunds == _challengeBankFunds)
        {
            _maxFundsError = "Maximum should exceed starting funds for meaningful challenge";
            isValid = false;
        }

        if (string.IsNullOrEmpty(_challengeRankId))
        {
            _rankError = "Please select a starting rank";
            isValid = false;
        }

        _isFormValid = isValid;
        StateHasChanged();
    }

    private async Task CreateChallenge()
    {
        if (!_isFormValid)
        {
            ValidateForm();
            return;
        }

        try
        {
            _isCreating = true;
            StateHasChanged();

            Logger.LogInformation("Creating new challenge: Funds {Start}-{Max}, Rank {RankId}", 
                _challengeBankFunds, _challengeMaxFunds, _challengeRankId);

            var newChallenge = Challenge.Create(
                "active", // Default status
                _challengeBankFunds,
                _challengeMaxFunds,
                _challengeRankId
            );

            var result = await ChallengeRepository.CreateAsync(newChallenge);

            if (result.IsSuccess)
            {
                Logger.LogInformation("Challenge created successfully: {ChallengeId}", newChallenge.Id);
                ResetForm();
            }
            else
            {
                _errorMessage = result.Error;
                Logger.LogError("Failed to create challenge: {Error}", result.Error);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unexpected error: {ex.Message}";
            Logger.LogError(ex, "Unexpected error creating challenge");
        }
        finally
        {
            _isCreating = false;
            StateHasChanged();
        }
    }

    private void ResetForm()
    {
        _challengeBankFunds = 500;
        _challengeMaxFunds = 2000;
        _challengeRankId = _ranks.FirstOrDefault()?.Id ?? "";
        _errorMessage = null;
        _showRankDropdown = false;
        ValidateForm();
    }

    private string GetRankDisplayName(string rankId)
    {
        var rank = _ranks.FirstOrDefault(r => r.Id == rankId);
        return rank?.GetDisplayName() ?? "Unknown";
    }

    private string GetDifficultyLevel()
    {
        if (_challengeMaxFunds <= 0 || _challengeBankFunds <= 0 || _averageKillerCost <= 0)
            return "Unknown";

        var initialMatches = _challengeBankFunds / _averageKillerCost;
        var maxMatches = _challengeMaxFunds / _averageKillerCost;
        var fundsRatio = (double)_challengeMaxFunds / _challengeBankFunds;
        
        return (initialMatches, maxMatches, fundsRatio) switch
        {
            var (init, max, _) when init < 3 || max < 10 => "Extreme",
            var (init, max, ratio) when init < 5 || max < 20 || ratio < 3 => "Hard",
            var (init, max, ratio) when init < 10 || max < 50 || ratio < 5 => "Medium",
            _ => "Easy"
        };
    }

    private void ToggleRankDropdown()
    {
        _showRankDropdown = !_showRankDropdown;
        StateHasChanged();
    }

    private void CloseRankDropdown()
    {
        _showRankDropdown = false;
        StateHasChanged();
    }

    private void SelectRank(string rankId)
    {
        _challengeRankId = rankId;
        _showRankDropdown = false;
        ValidateForm();
        StateHasChanged();
    }

    private string GetRankIcon(Rank rank)
    {
        return rank.Name.ToLower() switch
        {
            "ash" => "🥉",
            "bronze" => "🥉",
            "silver" => "🥈", 
            "gold" => "🥇",
            "iridescent" => "💎",
            _ => "📊"
        };
    }
}